# MAX30102

## 使用 MAX30102 模块的一般步骤

- **硬件连接**

将 MAX30102 模块连接到微控制器或其他处理器。
使用 I2C 接口与 MAX30102 通信。
确保 MAX30102 模块的电源电压在 2.7V 到 5.5V 之间。

- **初始化模块**

初始化 I2C 通信，设置合适的 I2C 引脚和时钟速率。
配置 MAX30102 模块，包括设置 LED 驱动电流、脉冲宽度、采样频率等。

- **配置中断**

配置 MAX30102 模块以在特定条件下产生中断，例如当血氧饱和度或心率超出阈值时。
配置中断引脚和中断服务程序（ISR）。

- **开始测量**

通过写入 MODE 寄存器启动 SpO2 或 HR 测量。

等待 MAX30102 模块完成测量并准备好数据。

- **读取数据**

  定期读取 MAX30102 模块的寄存器以获取血氧饱和度和心率数据。

  数据通常存储在不同的寄存器中，需要按照正确的顺序读取。

- **处理数据**

  根据需要处理血氧饱和度和心率数据。

  可能需要对数据进行过滤、平滑或其他处理以提高准确性。

- **停止测量**

  当不需要继续测量时，通过写入 MODE 寄存器停止测量。

  释放中断和相关的资源。

![](.\pictures\Quicker_20240715_103157.png)

![](.\pictures\Quicker_20240715_135323.png)

![](.\pictures\Quicker_20240715_140434.png)

![](.\pictures\Quicker_20240715_140449.png)

![](.\pictures\Quicker_20240715_140351.png)

![](.\pictures\Quicker_20240715_140508.png)

![](.\pictures\Quicker_20240715_140540.png)

- MAX30102 是一款集成了脉搏血氧仪和心率监测功能的生物传感器模块，它通常包括两个LED，一个红外LED和一个红光LED，用于通过光电容积描记图（PPG）技术来检测血液中的氧气饱和度和心率。
- 有软件寄存器。
- 32 深度的FIFO里存有数字输出数据。
- ADC转换器有18bit的分辨率，采样速率10.24MHZ，输出速率可以编程。
- MAX30102 这款设备在输出数据时，对于连接到其上的红外 LED 的波长变化不会非常敏感。
- 

## 红光LED

### 测量血氧饱和度

红光LED发出的光被血液中的血红蛋白吸收。血红蛋白对红光的吸收量会随着氧合状态的变化而变化，因此通过检测红光吸收的变化可以估算血氧饱和度（SpO2）。

### 心率监测

红光LED用于检测心脏跳动时血液体积的变化，因为每次心脏跳动都会导致血液量在血管中的增加，这会影响光的透射率。

## 红外LED

IR LED（infrared LED）

## 测量血氧饱和度

红外LED发出的光也被血液中的血红蛋白吸收，但其吸收特性与红光不同。红外光主要被脱氧血红蛋白吸收，而红光则更多地被氧合血红蛋白吸收。通过比较红光和红外光的吸收差异，可以更准确地计算血氧饱和度。

### 提高信号质量

由于红外光的波长比红光长，它穿透皮肤和组织的深度更深，因此可以提供更稳定的心率信号，尤其是在皮肤较深或颜色较暗的个体中。

## 温度传感器

MAX30102内置了一个芯片上的温度传感器，用于校准SpO2子系统的温度依赖性。该温度传感器的固有分辨率为0.0625°C。
设备输出数据对红外LED的波长相对不敏感，而红光LED的波长对于正确解释数据至关重要。使用MAX30102输出信号的血氧饱和度（SpO2）算法可以补偿环境温度变化所关联的SpO2误差。

## LED驱动器 

MAX30102集成了红光和红外LED驱动器，用于调节LED脉冲以进行血氧饱和度（SpO2）和心率（HR）测量。在适当的供电电压下，LED电流可以从0调节到50mA。LED脉冲宽度可以从69微秒编程到411微秒，以允许算法根据使用场景优化SpO2和HR的准确性和功耗。

## 接近功能 

设备包括一个接近功能，用于在用户的手指没有放在传感器上时节省电力并减少可见光发射。当启动SpO2或HR功能时（通过写入模式寄存器），IR LED将以由PILOT_PA寄存器设置的驱动电流在接近模式下激活。当检测到物体超过IR ADC计数阈值（在PROX_INT_THRESH寄存器中设置）时，部件将自动切换到正常的SpO2/HR模式。要重新进入接近模式，必须重新写入模式寄存器（即使值相同）。通过将PROX_INT_EN重置为0，可以禁用接近功能。在这种情况下，SpO2或HR模式将立即开始。

解释： 这段文字描述的是MAX30102传感器模块中的一个特性——接近功能。这个功能的设计目的是为了在不需要进行测量时节省电力和减少LED的可见光发射。

- **接近功能的激活**

当用户想要进行血氧饱和度（SpO2）或心率（HR）测量时，通过写入一个特定的模式寄存器来启动测量。此时，红外LED会在接近模式下被激活，其驱动电流由PILOT_PA寄存器设定。

- **物体检测**

在接近模式下，设备会检测是否有物体（如用户的手指）接近传感器。这是通过比较IR ADC（红外模数转换器）的计数和PROX_INT_THRESH寄存器中设置的阈值来实现的。如果计数超过阈值，说明有物体接近。

- **模式切换**

一旦检测到物体，设备会自动从接近模式切换到正常的SpO2/HR测量模式。
重新进入接近模式：如果需要重新启用接近模式，即使模式值没有变化，也需要重新写入模式寄存器。

- **禁用接近功能**

如果不想使用接近功能，可以通过将PROX_INT_EN寄存器的值设置为0来禁用。这样，一旦启动SpO2或HR测量，设备将不会进入接近模式，而是直接开始测量。

##  LED 驱动电流、脉冲宽度和采样频率

在 MAX30102 模块的配置中，设置 LED 驱动电流、脉冲宽度和采样频率是为了优化血氧饱和度（SpO2）和心率（HR）测量的准确性、功耗和信号质量。以下是这些配置参数的具体作用和设置方法：

LED 驱动电流：
作用：LED 驱动电流决定了 LED 发出的光强度，这对于正确检测血液中的血红蛋白吸收至关重要。过低的电流可能导致信号弱，而过高的电流可能会导致过热和 LED 寿命缩短。
设置：通过写入 PILOT_PA 和 LED1_PA 寄存器来设置红光 LED 和红外 LED 的驱动电流。这些寄存器的值范围通常在 0 到 50 mA 之间，可以按照需要进行编程。
脉冲宽度：
作用：脉冲宽度决定了 LED 脉冲的持续时间，这会影响光电二极管检测到的信号质量。适当的脉冲宽度可以提高信号的信噪比，但过长的脉冲宽度会增加功耗。
设置：通过写入 LED_PW 寄存器来设置 LED 脉冲的宽度。这个寄存器的值范围通常在 69 µs 到 411 µs 之间，可以根据使用场景进行编程。
采样频率：
作用：采样频率决定了 MAX30102 模块每秒钟采集的样本数。较高的采样频率可以提供更精确的数据，但会增加功耗和处理负担。
设置：通过写入 SAMPLE_RATE 寄存器来设置采样频率。这个寄存器的值范围通常在 50 Hz 到 1000 Hz 之间，可以根据需要进行编程。

## 程序编写

- 模式配置

  有两种模式，可以单独选，也可以一起用，分别是测血氧和心率。

  ![](.\pictures\Quicker_20240716_122640.png)

  ![](E:\Typora_doc\MAX30102\pictures\Quicker_20240716_114144.png)

  所以测心率是配置模式配置寄存器的0-2位为010，测血氧是011。

![](E:.\pictures\Quicker_20240716_120956.png)

![](.\pictures\Quicker_20240716_121105.png)

- 复位

  ![](.\pictures\Quicker_20240716_122640.png)

往模式配置寄存器中写0x40，将B6置位以复位。

- 使能中断

  中断使能位对应每个中断，电源除外。

  一共有6个中断。

- FIFO写指针

  ![](E:.\pictures\Quicker_20240716_124251.png)

FIFO这个数据结构有32的深度，每一个deep存6个字节的数据，对应IR LED和RED LED各自的3字节数据，所以FIFO共可以存192字节的数据。

读写指针和溢出计数器都是5位，就是2的5次方，等于32，以此选择对哪个deep进行操作。

- FIFO配置寄存器

  ![](E:.\pictures\Quicker_20240716_125017.png)

**Sample Averaging (SMP_AVE)**

这个寄存器的功能是允许用户选择是否对MAX30102模块中的ADC（模数转换器）输出的样本进行平均和降采样。当设置为1时，模块会对每个通道的相邻样本进行平均和降采样，以减少数据量。这种操作可以提高信号的信噪比，尤其是在低信噪比的环境中。然而，平均和降采样也会降低采样率和数据分辨率，因此在需要高采样率和分辨率的应用中可能不适用。

 **FIFO Rolls on Full (FIFO_ROLLOVER_EN)**

这个位的作用是决定当FIFO达到其最大容量时，模块如何处理新到来的数据。如果FIFO_ROLLOVER_EN被启用，当FIFO填满时，它将从零开始计数，继续接收新的数据样本。这意味着即使FIFO满了，也不会丢失任何数据，因为它会自动覆盖旧的数据。

如果FIFO_ROLLOVER_EN被禁用，当FIFO填满时，它将停止接收新的数据样本，直到FIFO_DATA被读取或WRITE/READ指针的位置被改变。这样可以防止FIFO溢出，并确保数据不会丢失。

**FIFO Almost Full Value (FIFO_A_FULL)**

这个寄存器设置了当中断发出时FIFO中剩余的数据样本数量（每个样本3字节）。例如，如果这个字段被设置为0x0，中断会在FIFO中剩余0个数据样本时发出（所有32个FIFO字都有未读的数据）。此外，如果这个字段被设置为0xF，中断会在FIFO中剩余15个数据样本时发出（17个FIFO数据样本有未读的数据）。

这个寄存器的作用是允许用户配置中断触发时的FIFO数据剩余量。当FIFO中的数据达到或超过这个值时，MAX30102模块会触发一个中断，通知用户可以开始读取数据了。通过调整这个值，用户可以控制中断触发的时机，从而根据实际应用的需要调整数据的读取速度。

- 血氧配置寄存器

  ![](E:.\pictures\Quicker_20240716_130211.png)

  **SpO2** **ADC Range Control**

​	SpO2传感器ADC的满量程范围决定了ADC能够读取的最大电压值，从而影响ADC的动态范围和灵敏度。通过设置这个寄存器，用户可以选择最适合其应用需求的ADC范围。

​	表5中应该列出了可用的ADC范围选项，以及每个选项对应的ADC满量程电压值。选择正确的ADC范围对于获得准确和可靠的心率、血氧饱和度和其他生命体征测量结果至关重要。

​	例如，如果应用需要高精度的测量，可能需要选择较高的ADC范围，以避免ADC饱和。相反，如果应用对精度要求不是很高，可以选择较低的ADC范围，以节省功耗和提高响应速度。

![](E:.\pictures\Quicker_20240716_130139.png)

​	**SpO2** **Sample Rate Control**

​	具体来说，这些位控制着SpO2模式下的样本采集速率。每个样本包含一个红外脉冲和一个红光脉冲的转换，因此每个样本实际上需要两个脉冲。通过设置这些位，用户可以控制MAX30102模块每秒钟采集的样本数。

![](E:.\pictures\Quicker_20240716_130655.png)

​	**LED Pulse Width Control and ADC Resolution**

​	在MAX30102模块中，这些位用于控制LED脉冲的宽度，即LED每次脉冲持续的时间。LED脉冲宽度对于光电容积描记图（PPG）信号的质量至关重要，因为它直接影响了光电二极管检测到的光强度和ADC的积分时间。

​	ADC的积分时间越长，ADC可以收集更多的信号信息，从而提高分辨率。因此，通过调整LED脉冲宽度，用户可以调整ADC的分辨率，以适应不同的应用需求。

![](E:.\pictures\Quicker_20240716_130940.png)

​	 **LED Current Control**

![](E:.\pictures\Quicker_20240716_131516.png)

![](E:.\pictures\Quicker_20240716_131525.png)